import{s as u}from"./supabase.ASU9rNY7.js";import"./hoisted.UJltcVt3.js";import"./index.BFAZBQoJ.js";const p=document.getElementById("login-form"),m=document.getElementById("error-message"),i=document.getElementById("error-text"),d=document.getElementById("success-message"),g=document.getElementById("success-text"),_=document.getElementById("google-signin-btn");function l(t,o="info"){g&&(g.textContent=t),d?.classList.remove("hidden"),d?.classList.add(o),o==="success"&&setTimeout(()=>{d?.classList.add("hidden")},3e3)}async function v(){try{l("Connecting to Google...","loading");const{data:t,error:o}=await u.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(o){console.error("Google auth error:",o);let r=o.message;o.message.includes("Provider not found")||o.message.includes("not configured")?r="Google provider not configured. Please contact administrator.":o.message.includes("redirect_uri_mismatch")?r="Redirect URI mismatch. Please contact administrator.":o.message.includes("access_denied")&&(r="Access denied. Please try again."),l(`Authentication failed: ${r}`,"error");return}l("Redirecting to Google...","loading")}catch(t){console.error("Google auth error:",t),l(`Authentication failed: ${t.message}`,"error")}}async function b(t){try{const{data:o,error:r}=await u.rpc("sync_google_user",{p_google_id:t.user_metadata.provider_id,p_email:t.email,p_name:t.user_metadata.full_name,p_picture:t.user_metadata.avatar_url,p_provider_id:t.user_metadata.provider_id});if(r){console.error("Sync error:",r);return}return console.log("Google user synced:",o),o}catch(o){console.error("Sync error:",o)}}_?.addEventListener("click",v);u.auth.onAuthStateChange(async(t,o)=>{if(t==="SIGNED_IN"&&o?.user){const r=o.user;r.app_metadata.provider==="google"&&(l("Syncing Google account...","loading"),await b(r),l("Successfully signed in with Google!","success"),setTimeout(()=>{window.location.href="/dashboard"},1500))}});p?.addEventListener("submit",async t=>{t.preventDefault();const o=new FormData(p),r=o.get("email"),h=o.get("password");if(!r||!h){i&&(i.textContent="Please fill in all fields."),m?.classList.remove("hidden");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)){i&&(i.textContent="Please enter a valid email address."),m?.classList.remove("hidden");return}m?.classList.add("hidden"),d?.classList.remove("hidden");const c=p.querySelector('button[type="submit"]'),w=c.textContent;c.disabled=!0,c.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Signing in...
    `;try{console.log("Attempting to sign in with Supabase:",r);const{data:s,error:n}=await u.auth.signInWithPassword({email:r,password:h});if(n)throw console.error("Supabase sign in error:",n),n;if(s.user){console.log("User signed in successfully:",s.user.email),g&&(g.textContent="Welcome back! Signing you in..."),d?.classList.remove("hidden");try{const{data:e,error:f}=await u.from("profiles").select("role, status, full_name, phone, company_name").eq("id",s.user.id).single();let a="/dashboard";if(!f&&e){console.log("âœ… User profile found:",e),console.log("ðŸ” Profile details:",{id:e.id,username:e.username,role:e.role,status:e.status,full_name:e.full_name}),e.role==="admin"||e.role==="developer"||e.role==="support"?(a="/admin",console.log(`ðŸŽ‰ ADMIN USER DETECTED: ${e.full_name} (${e.role})`),console.log(`ðŸš€ Redirecting to admin panel: ${a}`)):e.status&&e.status==="pending_verification"?(a="/dashboard?message=Please check your email to verify your account.&type=warning",console.log(`âš ï¸ Customer user with pending verification: ${e.full_name}`)):e.status&&e.status==="suspended"?(a="/dashboard?message=Your account has been suspended. Please contact support.&type=error",console.log(`âŒ Customer user suspended: ${e.full_name}`)):(a="/dashboard",console.log(`âœ… Customer user: ${e.full_name} (${e.role})`)),console.log(`ðŸŽ¯ Final redirect URL: ${a}`);const y={id:s.user.id,email:s.user.email,full_name:e.full_name||s.user.email?.split("@")[0]||"User",phone:e.phone||"Not set",company_name:e.company_name||"Not set",role:e.role||"customer"};window.dispatchEvent(new CustomEvent("user-logged-in",{detail:y})),console.log("âœ… User data sent to global auth manager:",y)}setTimeout(()=>{window.location.href=a},1500)}catch(e){console.warn("Could not fetch user profile, defaulting to dashboard:",e);const f={id:s.user.id,email:s.user.email,full_name:s.user.email?.split("@")[0]||"User",phone:"Not set",company_name:"Not set",role:"customer"};window.dispatchEvent(new CustomEvent("user-logged-in",{detail:f})),setTimeout(()=>{window.location.href="/dashboard"},1500)}}else throw new Error("Sign in failed - no user data returned")}catch(s){console.error("Login error:",s);let n="An error occurred during sign in.";s.message&&(s.message.includes("Invalid login credentials")?n="Invalid email or password. Please try again.":s.message.includes("Email not confirmed")?n="Please check your email and confirm your account before signing in.":s.message.includes("Too many requests")?n="Too many login attempts. Please try again later.":n=s.message),i&&(i.textContent=n),m?.classList.remove("hidden"),c.disabled=!1,c.textContent=w}});
