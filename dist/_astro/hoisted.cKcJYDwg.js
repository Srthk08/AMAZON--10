import{s as c}from"./supabase.ASU9rNY7.js";import"./hoisted.UJltcVt3.js";import"./index.BFAZBQoJ.js";const h=document.getElementById("signup-form"),i=document.getElementById("error-message"),a=document.getElementById("error-text"),b=document.getElementById("google-signup-btn");function l(s,e="info"){a&&(a.textContent=s),i?.classList.remove("hidden"),i?.classList.add(e),e==="success"&&setTimeout(()=>{i?.classList.add("hidden")},3e3)}async function x(){try{l("Connecting to Google...","loading");const{data:s,error:e}=await c.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(e){console.error("Google auth error:",e);let t=e.message;e.message.includes("Provider not found")||e.message.includes("not configured")?t="Google provider not configured. Please contact administrator.":e.message.includes("redirect_uri_mismatch")?t="Redirect URI mismatch. Please contact administrator.":e.message.includes("access_denied")&&(t="Access denied. Please try again."),l(`Authentication failed: ${t}`,"error");return}l("Redirecting to Google...","loading")}catch(s){console.error("Google auth error:",s),l(`Authentication failed: ${s.message}`,"error")}}async function A(s){try{const{data:e,error:t}=await c.rpc("sync_google_user",{p_google_id:s.user_metadata.provider_id,p_email:s.email,p_name:s.user_metadata.full_name,p_picture:s.user_metadata.avatar_url,p_provider_id:s.user_metadata.provider_id});if(t){console.error("Sync error:",t);return}return console.log("Google user synced:",e),e}catch(e){console.error("Sync error:",e)}}b?.addEventListener("click",x);c.auth.onAuthStateChange(async(s,e)=>{if(s==="SIGNED_IN"&&e?.user){const t=e.user;t.app_metadata.provider==="google"&&(l("Syncing Google account...","loading"),await A(t),l("Successfully signed up with Google!","success"),setTimeout(()=>{window.location.href="/dashboard"},1500))}});const C=new URLSearchParams(window.location.search),y=C.get("message"),I=C.get("type")||"success";y&&(I==="error"?(a&&(a.textContent=y),i?.classList.remove("hidden")):typeof window.showToast=="function"&&window.showToast(y,"success"),window.history.replaceState({},document.title,window.location.pathname));h?.addEventListener("submit",async s=>{s.preventDefault();const e=new FormData(h),t=e.get("email"),m=e.get("password"),E=e.get("confirm_password"),n=e.get("full_name"),g=e.get("phone"),p=e.get("company_name");if(i?.classList.add("hidden"),m!==E){a&&(a.textContent="Passwords do not match."),i?.classList.remove("hidden");return}if(m.length<6){a&&(a.textContent="Password must be at least 6 characters long."),i?.classList.remove("hidden");return}const d=h.querySelector('button[type="submit"]'),S=d.textContent;d.disabled=!0,d.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Creating account...
    `;try{console.log("Attempting to sign up with Supabase:",t);let o="customer";n.toLowerCase().includes("admin")||t.toLowerCase().includes("admin")?o="admin":n.toLowerCase().includes("developer")||t.toLowerCase().includes("developer")?o="developer":(n.toLowerCase().includes("support")||t.toLowerCase().includes("support"))&&(o="support");const{data:r,error:f}=await c.auth.signUp({email:t,password:m,options:{data:{full_name:n,phone:g,company_name:p,role:o,username:n.toLowerCase().replace(/\s+/g,"_")}}});if(f)throw console.error("Supabase signup error:",f),f;if(r.user){console.log("User created successfully in Auth:",r.user.email);const{error:_}=await c.from("profiles").insert({id:r.user.id,email:t,full_name:n,phone:g||null,company_name:p||null,role:o,status:"pending_verification",username:n.toLowerCase().replace(/\s+/g,"_"),created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(_){console.error("Error creating user profile:",_);try{await c.auth.admin.deleteUser(r.user.id)}catch(w){console.error("Error deleting auth user after profile creation failure:",w)}throw new Error("Failed to create user profile. Please try again.")}try{await c.from("user_activity_log").insert({user_id:r.user.id,action:"user_signup",details:{email:t,full_name:n,role:o,company_name:p,phone:g},ip_address:"127.0.0.1",user_agent:navigator.userAgent})}catch(w){console.warn("Could not log user activity:",w)}console.log("Complete user profile created successfully with role:",o),typeof window.showToast=="function"&&window.showToast(`Account created successfully! Welcome to DevExpress! Role: ${o}`,"success",3e3);let v="/login?message=Account created successfully! Please check your email to confirm your account before signing in.&type=success";o==="admin"&&(v="/login?message=Admin account created! Please check your email to confirm your account before signing in.&type=success"),setTimeout(()=>{window.location.href=v},2e3)}else throw new Error("Signup failed - no user data returned")}catch(o){console.error("Signup error:",o);let r="An error occurred during account creation.";o.message&&(o.message.includes("User already registered")?r="An account with this email already exists. Please try signing in instead.":o.message.includes("Password should be at least")?r="Password must be at least 6 characters long.":o.message.includes("Invalid email")?r="Please enter a valid email address.":o.message.includes("Failed to create user profile")?r="Account creation failed. Please try again or contact support.":r=o.message),a&&(a.textContent=r),i?.classList.remove("hidden"),d.disabled=!1,d.textContent=S}});const L=document.getElementById("password"),u=document.getElementById("confirm_password"),P=()=>{u.value&&L.value!==u.value?u.setCustomValidity("Passwords do not match"):u.setCustomValidity("")};L?.addEventListener("input",P);u?.addEventListener("input",P);
