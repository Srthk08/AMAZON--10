import{s as f}from"./supabase.ASU9rNY7.js";import"./hoisted.UJltcVt3.js";import"./AuthGuard.astro_astro_type_script_index_0_lang.D4Znhmp3.js";import"./index.BFAZBQoJ.js";function m(){console.log("populateUserData called");let a=null;try{const e=window.globalAuthManager||window.simpleAuthManager;e&&e.isUserLoggedIn()&&(a=e.getCurrentUser(),console.log("Found user data in global auth manager:",a))}catch(e){console.error("Error reading global auth manager:",e)}if(!a)try{const e=sessionStorage.getItem("simple-auth-session");if(e){const t=JSON.parse(e);t.user&&t.user.email&&(a=t.user,console.log("Found user data in sessionStorage:",a))}}catch(e){console.error("Error reading sessionStorage:",e)}if(!a)try{const e=localStorage.getItem("simple-auth-user");if(e){const t=JSON.parse(e);t.email&&(a=t,console.log("Found user data in localStorage:",a))}}catch(e){console.error("Error reading localStorage:",e)}if(a){console.log("Populating form with user data:",a);const e=document.getElementById("full_name"),t=document.getElementById("email"),s=document.getElementById("phone"),r=document.getElementById("company_name");e&&(e.value=a.full_name||a.fullName||""),s&&(s.value=a.phone||""),r&&(r.value=a.company_name||a.companyName||""),t&&(t.value=a.email||"No email available",t.readOnly=!0,t.disabled=!1,t.classList.add("bg-gray-50","cursor-not-allowed"),console.log("Email field populated with:",a.email))}else{console.log("No user data found, setting fallback values");const e=document.getElementById("email");e&&(e.value="Please log in to view email",e.readOnly=!0,e.disabled=!0,e.classList.add("bg-gray-100","cursor-not-allowed","text-gray-500"))}}function h(a){const e=document.getElementById("success-message");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3));const t=document.getElementById("update-btn");t&&(t.disabled=!1,t.innerHTML="Update Profile")}function y(a){const e=document.getElementById("password-success-message");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}function u(a){const e=document.getElementById("error-message"),t=document.getElementById("error-text");e&&t&&(t.textContent=a,e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}function i(a){const e=document.getElementById("password-error-message"),t=document.getElementById("password-error-text");e&&t&&(t.textContent=a,e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}const w=document.getElementById("profile-form");w?.addEventListener("submit",async a=>{a.preventDefault();const e=new FormData(w),t=e.get("full_name"),s=e.get("phone"),r=e.get("company_name");if(!t.trim()){u("Full name is required");return}const o=document.getElementById("update-btn");o.disabled=!0,o.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Updating...
    `;try{const n=window.globalAuthManager||window.simpleAuthManager,d=n?.getCurrentUser();if(!d){u("User not authenticated");return}const{data:g,error:l}=await f.from("profiles").update({full_name:t.trim(),phone:s.trim()||null,company_name:r.trim()||null,updated_at:new Date().toISOString()}).eq("id",d.id);if(l){console.error("Supabase update error:",l),u("Failed to update profile in database: "+l.message);return}if(console.log("✅ Profile updated in Supabase:",g),n){const v={...d,full_name:t.trim(),phone:s.trim()||void 0,company_name:r.trim()||void 0};n.updateProfile({full_name:t.trim(),phone:s.trim()||void 0,company_name:r.trim()||void 0}),console.log("✅ Profile updated in global auth manager")}h("Profile updated successfully and permanently!");const c=document.getElementById("error-message");c&&c.classList.add("hidden"),window.dispatchEvent(new CustomEvent("auth-state-changed"))}catch(n){console.error("Profile update error:",n),u(n.message||"Failed to update profile")}finally{o.disabled=!1,o.innerHTML="Update Profile"}});const p=document.getElementById("password-form");p?.addEventListener("submit",async a=>{a.preventDefault();const e=new FormData(p),t=e.get("current_password"),s=e.get("new_password"),r=e.get("confirm_password");if(!t||!s||!r){i("All password fields are required");return}if(s!==r){i("New password and confirm password do not match");return}if(s.length<6){i("New password must be at least 6 characters long");return}const o=document.getElementById("change-password-btn");if(!o){console.error("Change password button not found");return}o.disabled=!0,o.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Changing Password...
    `;try{const d=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!d||!d.id){i("User not authenticated. Please login again."),o.disabled=!1,o.innerHTML="Change Password";return}console.log("Changing password for user:",d.id);const{data:g,error:l}=await f.auth.updateUser({password:s});if(l){console.error("Password update error:",l),i("Failed to update password: "+l.message);return}console.log("✅ Password updated in Supabase:",g),y("Password changed successfully and permanently!"),p.reset();const c=document.getElementById("password-error-message");c&&c.classList.add("hidden"),window.dispatchEvent(new CustomEvent("auth-state-changed"))}catch(n){console.error("Password change error:",n),i(n.message||"Failed to change password")}finally{o&&(o.disabled=!1,o.innerHTML="Change Password")}});console.log("Script loaded, populating user data immediately");m();document.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded event fired"),m()});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded event listener added"),m()}):(console.log("Document already loaded, populating immediately"),m());
